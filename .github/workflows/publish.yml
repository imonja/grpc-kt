name: Publish to GitHub Packages and Maven Central

on:
    push:
        branches: [ main ]
        tags:
            - '*'

jobs:
    ci-checks:
        uses: ./.github/workflows/ci-checks.yml
        with:
            run-ktlint: true
            run-tests: true

    publish-release:
        needs: ci-checks
        runs-on: ubuntu-latest
        concurrency: publishing-ci
        permissions:
            packages: write
            contents: write
            actions: read
            checks: write
            id-token: write
        name: Publish Libraries

        steps:
            -   uses: actions/checkout@v6
                with:
                    fetch-depth: 0

            -   name: Setup JDK
                uses: actions/setup-java@v5.0.0
                with:
                    distribution: 'temurin'
                    java-version: 21

            -   name: Setup Gradle for a non-wrapper project
                uses: gradle/actions/setup-gradle@v5
                with:
                    gradle-version: wrapper

            -   uses: paulhatch/semantic-version@v5.4.0
                id: tag
                with:
                    bump_each_commit: true
                    bump_each_commit_patch_pattern: "(BUMP)"
                    tag_prefix: ""

            -   name: Get version
                id: version
                run: |
                    if [[ ${GITHUB_REF} == refs/tags/* ]]; then
                      echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
                      echo "is_tag=true" >> $GITHUB_OUTPUT
                    else
                      echo "version=${{ steps.tag.outputs.version }}" >> $GITHUB_OUTPUT
                      echo "is_tag=false" >> $GITHUB_OUTPUT
                    fi

#            -   name: Publish Libraries
#                if: ${{ steps.version.outputs.is_tag == 'true' || steps.tag.outputs.version_type != 'none' }}
#                run: ./gradlew -PreleaseVersion=${{ steps.version.outputs.version }} publish -x check
#                env:
#                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#                    GITHUB_USERNAME: ${{ github.actor }}
#                    ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
#                    ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
#                    ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
#                    ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

            -   name: Publish Gradle Plugin to GitHub Packages and Maven Central
                if: ${{ steps.version.outputs.is_tag == 'true' || steps.tag.outputs.version_type != 'none' }}
                run: ./gradlew :gradle-plugin:publish -PreleaseVersion=${{ steps.version.outputs.version }} -x check
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    GITHUB_USERNAME: ${{ github.actor }}
                    ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
                    ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
                    ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
                    ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

            -   name: Publish Gradle Plugin to Gradle Plugin Portal
                if: ${{ (steps.version.outputs.is_tag == 'true' || steps.tag.outputs.version_type != 'none') && !contains(steps.version.outputs.version, 'SNAPSHOT') }}
                run: ./gradlew :gradle-plugin:publishPlugins -PreleaseVersion=${{ steps.version.outputs.version }} -x check
                env:
                    ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
                    ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
                    GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
                    GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}

            -   uses: actions/create-release@v1.1.4
                if: ${{ steps.version.outputs.is_tag == 'false' && steps.tag.outputs.version_type != 'none' }}
                id: create_release
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    tag_name: ${{ steps.version.outputs.version }}
                    release_name: ${{ steps.version.outputs.version }}
                    body: |
                        Changes in this Release
                        ${{ steps.notes.outputs.CHANGELOG }}
